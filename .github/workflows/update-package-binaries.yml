name: Update Package Binaries

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag from Gao-OS/mobile-BEAM-OTP (e.g., v26.2.5.8)'
        required: true
        type: string
  schedule:
    # Check for new releases weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

env:
  SOURCE_REPO: Gao-OS/mobile-BEAM-OTP

jobs:
  check-release:
    name: Check for New Release
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.release.outputs.tag }}
      should_update: ${{ steps.release.outputs.should_update }}
    steps:
      - uses: actions/checkout@v4

      - name: Get release tag
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.release_tag }}"
            echo "Using manual tag: $TAG"
          else
            # Get latest release from source repo
            TAG=$(gh release list --repo ${{ env.SOURCE_REPO }} --limit 1 --json tagName --jq '.[0].tagName')
            echo "Latest release from ${{ env.SOURCE_REPO }}: $TAG"
          fi

          if [ -z "$TAG" ]; then
            echo "Error: No release tag found"
            exit 1
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Check if we already have a PR or commit for this tag
          EXISTING_PR=$(gh pr list --search "update binaries from $TAG" --json number --jq 'length')
          if [ "$EXISTING_PR" -gt 0 ]; then
            echo "PR already exists for $TAG, skipping"
            echo "should_update=false" >> $GITHUB_OUTPUT
          else
            echo "should_update=true" >> $GITHUB_OUTPUT
          fi

  update-binaries:
    name: Update Binaries and Create PR
    runs-on: ubuntu-latest
    needs: check-release
    if: needs.check-release.outputs.should_update == 'true'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Download Android binaries
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.check-release.outputs.tag }}"
          echo "Downloading Android binaries for $TAG from ${{ env.SOURCE_REPO }}"

          # Download android-runtime.zip from source repo release
          gh release download "$TAG" \
            --repo ${{ env.SOURCE_REPO }} \
            --pattern "android-runtime.zip" \
            --output android-runtime.zip

          # Extract and copy to package
          unzip android-runtime.zip -d android-runtime

          # Copy liberlang.a files to package
          for ABI in arm64-v8a armeabi-v7a x86_64; do
            mkdir -p "packages/beam_vm_android/android/src/main/jniLibs/$ABI"
            if [ -f "android-runtime/$ABI/liberlang.a" ]; then
              cp "android-runtime/$ABI/liberlang.a" "packages/beam_vm_android/android/src/main/jniLibs/$ABI/"
              echo "Copied liberlang.a for $ABI"
            fi
          done

          # Cleanup
          rm -rf android-runtime android-runtime.zip

      - name: Download iOS xcframework
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.check-release.outputs.tag }}"
          echo "Downloading iOS xcframework for $TAG from ${{ env.SOURCE_REPO }}"

          # Download liberlang.xcframework.zip from source repo release
          gh release download "$TAG" \
            --repo ${{ env.SOURCE_REPO }} \
            --pattern "liberlang.xcframework.zip" \
            --output liberlang.xcframework.zip

          # Extract and copy to package
          unzip liberlang.xcframework.zip -d ios-framework

          # Copy xcframework to package
          rm -rf "packages/beam_vm_ios/ios/Assets/liberlang.xcframework"
          mkdir -p "packages/beam_vm_ios/ios/Assets"
          cp -r ios-framework/liberlang.xcframework "packages/beam_vm_ios/ios/Assets/"
          echo "Copied liberlang.xcframework"

          # Cleanup
          rm -rf ios-framework liberlang.xcframework.zip

      - name: Verify binaries
        run: |
          echo "=== Android binaries ==="
          ls -lah packages/beam_vm_android/android/src/main/jniLibs/*/

          echo "=== iOS xcframework ==="
          ls -lah packages/beam_vm_ios/ios/Assets/liberlang.xcframework/

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ needs.check-release.outputs.tag }}"
          BRANCH="update-binaries-$TAG"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch
          git checkout -b "$BRANCH"

          # Stage changes
          git add packages/beam_vm_android/android/src/main/jniLibs/
          git add packages/beam_vm_ios/ios/Assets/liberlang.xcframework/

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit and push
          git commit -m "chore(binaries): update from mobile-BEAM-OTP $TAG"
          git push origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "chore(binaries): update binaries from $TAG" \
            --body "## Summary

          Updates BEAM runtime binaries from [mobile-BEAM-OTP $TAG](https://github.com/${{ env.SOURCE_REPO }}/releases/tag/$TAG).

          ### Changes
          - Android: \`liberlang.a\` for arm64-v8a, armeabi-v7a, x86_64
          - iOS: \`liberlang.xcframework\` for arm64 and simulators

          ### Source
          - Repository: https://github.com/${{ env.SOURCE_REPO }}
          - Release: $TAG

          ---
          *Auto-generated by update-package-binaries workflow*" \
            --base main \
            --head "$BRANCH"
